<div class="history-container">
  <div class="history-header">
    <div class="header-left">
      <h1>
        <span class="material-icons">history</span>
        Histórico do Paciente
      </h1>
      <p class="subtitle">Consultas anteriores, diagnósticos e evolução</p>
    </div>
    <div class="header-right">
      <button class="btn-action" (click)="refresh()">
        <span class="material-icons">refresh</span>
        Atualizar
      </button>
      <button class="btn-action btn-integrate">
        <span class="material-icons">sync</span>
        Integrar PEC-SUS
      </button>
    </div>
  </div>

  <div class="patient-profile">
    <div class="profile-card">
      <div class="profile-avatar">
        <span class="material-icons" style="font-size: 64px; color: var(--primary);">person</span>
      </div>
      <div class="profile-info">
        <h2 class="profile-name">{{ patient?.name || 'Paciente' }}</h2>
        <div class="profile-meta">
          <div class="meta-item">
            <span class="material-icons">badge</span>
            <span>{{ patient?.cpf || 'CPF não informado' }}</span>
          </div>
          <div class="meta-item" *ngIf="patient?.birthDate">
            <span class="material-icons">cake</span>
            <span>{{ patient?.birthDate | date:'dd/MM/yyyy' }} ({{ getAge(patient?.birthDate || '') }} anos)</span>
          </div>
          <div class="meta-item" *ngIf="patient?.motherName">
            <span class="material-icons">family_restroom</span>
            <span>Mãe: {{ patient?.motherName }}</span>
          </div>
        </div>
        <div class="profile-location" *ngIf="patient?.city">
          <span class="material-icons">location_on</span>
          <span>{{ patient?.city }}, {{ patient?.state }}</span>
        </div>
      </div>
    </div>
    <div class="profile-actions">
      <button class="btn-history active">
        <span class="material-icons">history</span>
        Histórico
      </button>
      <button class="btn-analysis" (click)="navigateToAnalysis()">
        <span class="material-icons">analytics</span>
        Análise de Paciente
      </button>
    </div>
  </div>

  <div class="history-content">
    <div class="history-section">
      <div class="section-header">
        <span class="material-icons">event_note</span>
        <h2>Atendimentos e Consultas</h2>
      </div>

      <ng-container *ngIf="!loading; else loadingTemplate">
        <div class="history-list" *ngIf="patientHistory.length > 0; else emptyHistory">
          <div *ngFor="let record of patientHistory" class="history-card">
            <div class="history-card-header">
              <div class="header-left">
                <div class="appointment-type">
                  <span class="material-icons" 
                    [ngClass]="{
                      'icon-doctor': record.type.includes('Consulta') || record.type.includes('Médica'),
                      'icon-nurse': record.type.includes('Enfermagem') || record.type.includes('Triagem')
                    }">
                    {{ record.type.includes('Consulta') || record.type.includes('Médica') ? 'medical_services' : 'healing' }}
                  </span>
                  <h3>{{ record.type }}</h3>
                </div>
                <span class="appointment-date">{{ record.date }}</span>
                <div class="professional-info" *ngIf="record.professionalName">
                  <span class="material-icons">person</span>
                  <span>{{ record.professionalName }} ({{ record.professionalRole }})</span>
                </div>
              </div>
              <div class="header-right">
                <span class="status-badge" [ngClass]="{
                  'status-completed': record.status === 'Finalizado',
                  'status-follow-up': record.status === 'Acompanhamento',
                  'status-evolution': record.status === 'Evolução'
                }">{{ record.status }}</span>
              </div>
            </div>
            
            <div class="history-card-content">
              <div class="info-group" *ngIf="record.consultReason">
                <span class="info-label">Motivo da Consulta:</span>
                <span class="info-value">{{ record.consultReason }}</span>
              </div>

              <div class="info-group" *ngIf="record.symptoms && record.symptoms.length > 0">
                <span class="info-label">Sintomas:</span>
                <div class="symptoms-display">
                  <span *ngFor="let symptom of record.symptoms" class="symptom-chip">{{ symptom }}</span>
                  <div *ngIf="record.otherSymptoms" class="other-symptoms">
                    <strong>Outros:</strong> {{ record.otherSymptoms }}
                  </div>
                </div>
              </div>

              <div class="info-group" *ngIf="record.duration">
                <span class="info-label">Duração dos Sintomas:</span>
                <span class="info-value">{{ record.duration }}</span>
              </div>

              <div class="info-group" *ngIf="record.intensity">
                <span class="info-label">Intensidade:</span>
                <span class="info-value intensity-badge" [ngClass]="getIntensityClass(record.intensity)">
                  {{ record.intensity }}
                </span>
              </div>

              <div class="info-group" *ngIf="record.priority">
                <span class="info-label">Prioridade:</span>
                <span class="info-value priority-badge" [ngClass]="getPriorityClass(record.priority)">
                  {{ record.priority }}
                </span>
              </div>
              
              <div class="info-group">
                <span class="info-label">Diagnóstico:</span>
                <span class="info-value">{{ record.diagnosis }}</span>
              </div>
              
              <div class="info-group">
                <span class="info-label">Medicamentos:</span>
                <span class="info-value">{{ record.medications }}</span>
              </div>
              
              <div class="info-group">
                <span class="info-label">Evolução:</span>
                <span class="info-value">{{ record.evolution }}</span>
              </div>

              <div class="info-group" *ngIf="record.allergies">
                <span class="info-label">Alergias:</span>
                <span class="info-value">{{ record.allergies }}</span>
              </div>

              <div class="info-group" *ngIf="record.observations">
                <span class="info-label">Observações:</span>
                <span class="info-value">{{ record.observations }}</span>
              </div>
            </div>
            
            <div class="history-card-footer">
              <button class="btn-details" (click)="viewDetails(record)">
                <span class="material-icons">visibility</span>
                Detalhes Completos
              </button>
            </div>
          </div>
        </div>

        <ng-template #emptyHistory>
          <div class="empty-history">
            <span class="material-icons">info</span>
            <p>Não há histórico de atendimentos para este paciente.</p>
          </div>
        </ng-template>
      </ng-container>

      <ng-template #loadingTemplate>
        <div class="loading">
          <div class="spinner"></div>
          <p>Carregando histórico do paciente...</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div *ngIf="selectedRecord" class="modal-overlay" (click)="closeDetails()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalhes Completos da Consulta</h3>
      <button class="btn-close" (click)="closeDetails()">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="detail-section">
        <h4>Informações Gerais</h4>
        <div class="detail-item">
          <span class="detail-label">Data/Hora:</span>
          <span class="detail-value">{{ selectedRecord.date }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Tipo:</span>
          <span class="detail-value">{{ selectedRecord.type }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Profissional:</span>
          <span class="detail-value">{{ selectedRecord.professionalName }} ({{ selectedRecord.professionalRole }})</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Status:</span>
          <span class="detail-value">{{ selectedRecord.status }}</span>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedRecord.consultReason">
        <h4>Motivo da Consulta</h4>
        <div class="detail-item">
          <span class="detail-value">{{ selectedRecord.consultReason }}</span>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedRecord.symptoms && selectedRecord.symptoms.length > 0">
        <h4>Sintomas Apresentados</h4>
        <div class="symptoms-display">
          <span *ngFor="let symptom of selectedRecord.symptoms" class="symptom-chip">{{ symptom }}</span>
        </div>
        <div *ngIf="selectedRecord.otherSymptoms" class="detail-item">
          <span class="detail-label">Outros sintomas:</span>
          <span class="detail-value">{{ selectedRecord.otherSymptoms }}</span>
        </div>
        <div *ngIf="selectedRecord.duration" class="detail-item">
          <span class="detail-label">Duração:</span>
          <span class="detail-value">{{ selectedRecord.duration }}</span>
        </div>
        <div *ngIf="selectedRecord.intensity" class="detail-item">
          <span class="detail-label">Intensidade:</span>
          <span class="detail-value">{{ selectedRecord.intensity }}</span>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedRecord.vitalSigns && hasVitalSigns(selectedRecord.vitalSigns)">
        <h4>Sinais Vitais</h4>
        <div class="vital-signs-grid">
          <div *ngIf="selectedRecord.vitalSigns.temperature" class="vital-item">
            <span class="vital-label">Temperatura:</span>
            <span class="vital-value">{{ selectedRecord.vitalSigns.temperature }}°C</span>
          </div>
          <div *ngIf="selectedRecord.vitalSigns.heartRate" class="vital-item">
            <span class="vital-label">Freq. Cardíaca:</span>
            <span class="vital-value">{{ selectedRecord.vitalSigns.heartRate }} bpm</span>
          </div>
          <div *ngIf="selectedRecord.vitalSigns.respiratoryRate" class="vital-item">
            <span class="vital-label">Freq. Respiratória:</span>
            <span class="vital-value">{{ selectedRecord.vitalSigns.respiratoryRate }} rpm</span>
          </div>
          <div *ngIf="selectedRecord.vitalSigns.bloodPressureSystolic && selectedRecord.vitalSigns.bloodPressureDiastolic" class="vital-item">
            <span class="vital-label">Pressão Arterial:</span>
            <span class="vital-value">{{ selectedRecord.vitalSigns.bloodPressureSystolic }}/{{ selectedRecord.vitalSigns.bloodPressureDiastolic }} mmHg</span>
          </div>
          <div *ngIf="selectedRecord.vitalSigns.oxygenSaturation" class="vital-item">
            <span class="vital-label">Sat. Oxigênio:</span>
            <span class="vital-value">{{ selectedRecord.vitalSigns.oxygenSaturation }}%</span>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>Diagnóstico e Tratamento</h4>
        <div class="detail-item">
          <span class="detail-label">Diagnóstico:</span>
          <span class="detail-value">{{ selectedRecord.diagnosis }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Medicamentos:</span>
          <span class="detail-value">{{ selectedRecord.medications }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Evolução:</span>
          <span class="detail-value">{{ selectedRecord.evolution }}</span>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedRecord.allergies">
        <h4>Alergias</h4>
        <div class="detail-item">
          <span class="detail-value">{{ selectedRecord.allergies }}</span>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedRecord.observations">
        <h4>Observações</h4>
        <div class="detail-item">
          <span class="detail-value">{{ selectedRecord.observations }}</span>
        </div>
      </div>
    </div>
  </div>
</div>